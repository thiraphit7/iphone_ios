name: Build SEPwn iOS App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: List available schemes
      run: xcodebuild -project SEPwn.xcodeproj -list
      
    - name: Build for iOS Device (arm64)
      run: |
        xcodebuild \
          -project SEPwn.xcodeproj \
          -scheme SEPwn \
          -configuration Release \
          -sdk iphoneos \
          -arch arm64 \
          -derivedDataPath build \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES \
          ONLY_ACTIVE_ARCH=NO \
          ENABLE_BITCODE=NO \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=NO \
          clean build
          
    - name: Verify build output
      run: |
        echo "=== Build Products ==="
        find build -name "*.app" -type d
        echo "=== App Contents ==="
        APP_PATH=$(find build -name "SEPwn.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          ls -la "$APP_PATH/"
          echo "=== Executable Check ==="
          if [ -f "$APP_PATH/SEPwn" ]; then
            echo "✅ Executable found!"
            file "$APP_PATH/SEPwn"
          else
            echo "❌ Executable NOT found!"
            echo "Looking for any executables..."
            find "$APP_PATH" -type f -perm +111
          fi
        fi
          
    - name: Create IPA
      run: |
        APP_PATH=$(find build -name "SEPwn.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          echo "=== Payload Contents ==="
          ls -la Payload/SEPwn.app/
          zip -r SEPwn-unsigned.ipa Payload
          echo "=== IPA Contents ==="
          unzip -l SEPwn-unsigned.ipa
        else
          echo "No .app found!"
          exit 1
        fi
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: SEPwn-unsigned-ipa
        path: SEPwn-unsigned.ipa
        
    - name: Upload App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: SEPwn-app-bundle
        path: build/Build/Products/Release-iphoneos/SEPwn.app
