/*
 * exploit_utils.h - Exploit Utility Functions
 * 
 * This header declares utility functions used by the exploit chain.
 */

#ifndef SEPWN_EXPLOIT_UTILS_H
#define SEPWN_EXPLOIT_UTILS_H

#include "common.h"

/* Process Utilities */
kaddr_t find_proc_by_pid(pid_t pid);
kaddr_t find_proc_by_name(const char *name);
kaddr_t get_proc_task(kaddr_t proc);
kaddr_t get_proc_ucred(kaddr_t proc);
pid_t get_proc_pid(kaddr_t proc);

/* Task Utilities */
kaddr_t get_task_ipc_space(kaddr_t task);
kaddr_t get_task_vm_map(kaddr_t task);
kaddr_t get_task_bsd_info(kaddr_t task);

/* Credential Utilities */
int set_uid(kaddr_t ucred, uid_t uid);
int set_gid(kaddr_t ucred, gid_t gid);
int set_all_uids(kaddr_t ucred, uid_t uid);
int set_all_gids(kaddr_t ucred, gid_t gid);
kaddr_t get_cred_label(kaddr_t ucred);

/* Sandbox Utilities */
int sandbox_escape(kaddr_t ucred);
bool is_sandboxed(kaddr_t ucred);

/* Code Signing Utilities */
int disable_cs_enforcement(kaddr_t proc);
int add_cs_flags(kaddr_t proc, uint32_t flags);
int remove_cs_flags(kaddr_t proc, uint32_t flags);
uint32_t get_cs_flags(kaddr_t proc);

/* AMFI Utilities */
int amfi_allow_any_signature(void);
int amfi_disable_library_validation(void);

/* Kernel Patching */
int patch_kernel_security(void);
int unpatch_kernel_security(void);

/* Port Utilities */
mach_port_t create_port_with_kobject(kaddr_t kobject, uint32_t type);
kaddr_t get_port_kobject(mach_port_t port);
int convert_port_to_tfp0(mach_port_t port);

/* Memory Utilities */
kaddr_t kernel_vm_allocate(size_t size);
int kernel_vm_deallocate(kaddr_t addr, size_t size);
int kernel_vm_protect(kaddr_t addr, size_t size, vm_prot_t prot);

/* IOKit Utilities */
io_connect_t open_iokit_service(const char *name, uint32_t type);
int call_iokit_method(io_connect_t conn, uint32_t selector,
                      uint64_t *input_scalars, uint32_t input_scalar_count,
                      void *input_struct, size_t input_struct_size,
                      uint64_t *output_scalars, uint32_t *output_scalar_count,
                      void *output_struct, size_t *output_struct_size);

/* Heap Spray */
int heap_spray_start(size_t object_size, int count);
void heap_spray_stop(void);
int heap_spray_trigger_gc(void);

/* Timing Utilities */
uint64_t get_time_ns(void);
void sleep_ms(uint32_t ms);

/* Debugging */
void hexdump(const void *data, size_t size);
void hexdump_kernel(kaddr_t addr, size_t size);

#endif /* SEPWN_EXPLOIT_UTILS_H */
